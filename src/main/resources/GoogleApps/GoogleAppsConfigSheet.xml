<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.5" reference="GoogleApps.GoogleAppsConfigSheet" locale="">
  <web>GoogleApps</web>
  <name>GoogleAppsConfigSheet</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>GoogleApps.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>#if($doc.fullName=="GoogleApps.GoogleAppsConfigSheet")Google Apps Config Sheet#else $doc.title #end</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
$xwiki.jsx.use('GoogleApps.GoogleAppsConfigClass')
$xwiki.ssx.use('GoogleApps.GoogleAppsConfigClass')

#set($configClassName="GoogleApps.GoogleAppsConfig")
#set($formId = "${section.toLowerCase()}_${configClassName}")
#set($configDoc = $xwiki.getDocument($configClassName))
#set($className="GoogleApps.GoogleAppsConfigClass")
#set($propNamePrefix="${configDoc.fullName}_${className}_0")
#set($obj = $configDoc.getObject($className))
## shorthand for t(ranslation) and tp(translation with parameters).
#macro (t $name)
  $services.localization.render("GoogleApps.GoogleAppsConfigClass_${name}")
#end
#macro (tp $name $params)
  #set ($transNamePrefix = 'GoogleApps.GoogleAppsConfigClass_')
  #if ($name.startsWith("googleapps"))
    #set($transNamePrefix='')
  #end
  #set ($msg = $services.localization.render("GoogleApps.GoogleAppsConfigClass_${name}",$params))
  ## convert to &lt;a href="link"&gt;link-text&lt;/a&gt; for the simple wiki syntax of links
  $stringtool.replacePattern($msg, '\[\[([^&gt;]*)&gt;&gt;([^\]]*)\]\]', '&lt;a href="$2"&gt;$1&lt;/a&gt;')
#end
#macro (displayInput $property)
  #set ($output = $doc.display($property, 'edit', $obj))
  #set ($output = $stringtool.removeStart($output, '{{html clean="false" wiki="false"}}'))
  #set ($output = $stringtool.removeEnd($output, '{{/html}}'))
  $output
#end

#if(!$xwiki.hasAdminRights())
  Admin rights needed.
#else
  $services.localization.render('googleapps.config.explanation')

  {{html clean="false"}}

  &lt;form id="$formId" method="post" action="$xwiki.getURL($configDoc, 'saveandcontinue')" class="xform"&gt;
    &lt;dl&gt;
      &lt;dt&gt;#displayInput ('activate') &lt;label for="${propNamePrefix}_activate"&gt;#t ('activate')&lt;/label&gt;&lt;/dt&gt;
      &lt;dd&gt;&lt;/dd&gt;
    &lt;/dl&gt;

    &lt;fieldset&gt;
      &lt;legend&gt;#t ('communicate')&lt;/legend&gt;

      &lt;dl&gt;
        &lt;dt&gt;&lt;span class="xHint"&gt;
          #tp ('communicate.hint',  ['[[', '&gt;&gt;https://accounts.google.com/ManageDomains]]'])&lt;br&gt;
          #tp ('communicate.hint2', ['[[', '&gt;&gt;https://store.xwiki.com/xwiki/bin/view/Extension/GoogleAppsIntegration#installation]]'])&lt;/span&gt;
        &lt;/dt&gt;
        &lt;dd&gt;&lt;/dd&gt;
      &lt;/dl&gt;


      &lt;dl&gt;
        &lt;dt&gt;&lt;label for="${propNamePrefix}_clientid"&gt;#t ('clientid')&lt;/label&gt;
          &lt;span class="xHint"&gt;#t ("clientid.hint")&lt;/span&gt;&lt;/dt&gt;
        &lt;dd&gt; #displayInput ('clientid')&lt;/dd&gt;
      &lt;/dl&gt;

      &lt;dl&gt;
        &lt;dt&gt;&lt;label for="${propNamePrefix}_secret"&gt;#t ('secret')&lt;/label&gt;
          &lt;span class="xHint"&gt;#t("secret.hint")&lt;/span&gt;&lt;/dt&gt;
        &lt;dd&gt; #displayInput ("secret")&lt;/dd&gt;
      &lt;/dl&gt;

      ## checkboxes for scope, needs JS
      &lt;dl&gt;
        &lt;dt&gt;&lt;label&gt;#t ('scope')&lt;/label&gt;
          &lt;span class="xHint"&gt;#t ('scope.hint')&lt;/span&gt;&lt;/dt&gt;
        &lt;dd&gt;
          &lt;label title="#t ('checkbox_mandatory')"&gt;
            &lt;input type="checkbox" name="scope_identity" disabled="true" checked&gt;#t ('scope_identity')&lt;/label&gt;
          &lt;label title="#t ('checkbox_mandatory')"&gt;
            &lt;input type="checkbox" name="scope_email"    disabled="true" checked&gt;#t ("scope_email")&lt;/label&gt;
          &lt;label title="#t('checkbox_mandatory')"&gt;
            &lt;input type="checkbox" name="scope_drive" &gt;#t ('scope_drive')&lt;/label&gt;
          &lt;label title="#t('checkbox_notyetdone')"&gt;
            &lt;input type="checkbox" name="scope_avatar"&gt;#t ('scope_avatar')&lt;/label&gt;
          &lt;input type="hidden" name="GoogleApps.GoogleAppsConfigClass_0_scope" value="${obj.getValue('scope')}"/&gt;
        &lt;/dd&gt;
      &lt;/dl&gt;

      &lt;dl&gt;
        &lt;dt&gt;&lt;label for="${propNamePrefix}_appname"&gt;#t ('appname')&lt;/label&gt;
          &lt;span class="xHint"&gt;#t ('appname.hint')&lt;/span&gt;&lt;/dt&gt;
        &lt;dd&gt; #displayInput ('appname')&lt;/dd&gt;
      &lt;/dl&gt;
    &lt;/fieldset&gt;

    #if ($services.googleAppsService.missesAuthenticationConfig())
      &lt;div class="box warningmessage"&gt;
        &lt;p&gt;$services.localization.render('googleapps.error.authConfigNotFound')&lt;br&gt;
          #tp('googleapps.error.authConfigShould',
            ['[[','&gt;&gt;https://store.xwiki.com/xwiki/bin/view/Extension/GoogleAppsIntegration#installation]]'])&lt;/p&gt;
          &lt;div class="box"&gt;
            &lt;div class="code" style="user-select: all; cursor: pointer;"
              &gt;xwiki.authentication.authclass=com.xpn.xwiki.user.impl.xwiki.GroovyAuthServiceImpl
              xwiki.authentication.groovy.pagename=xwiki:GoogleApps.AuthService&lt;/div&gt;
          &lt;/div&gt;
      &lt;/div&gt;
    #end

    &lt;fieldset&gt;
      &lt;legend&gt;#t ('loginbehaviour')&lt;/legend&gt;

      &lt;dl&gt;
        &lt;dt&gt;&lt;label for="${propNamePrefix}_domain"&gt;#t ('domain')&lt;/label&gt;
            &lt;span class="xHint"&gt;#t("domain.hint")&lt;/span&gt;&lt;/dt&gt;
        &lt;dd&gt; #displayInput ("domain")&lt;br&gt;
            &lt;span id="googleapps-domain-livehint" class="xHint"&gt;&amp;nbsp;&lt;/span&gt;&lt;/dd&gt;
      &lt;/dl&gt;

      &lt;dl&gt;
          &lt;dt&gt;#displayInput ('useCookies') &lt;label for="${propNamePrefix}_useCookies"&gt;#t ('useCookies')&lt;/label&gt;
          &lt;span class="xHint"&gt;#t ('useCookies.hint')&lt;/span&gt;&lt;/dt&gt;
          &lt;dd&gt;
            &lt;dl&gt;
              &lt;dt&gt;#displayInput ('skipLoginPage')
                &lt;label for="${propNamePrefix}_skipLoginPage"&gt;#t ('skipLoginPage')&lt;/label&gt;
                &lt;span class="xHint"&gt;#t ('skipLoginPage.hint')&lt;/span&gt;&lt;/dt&gt;
              &lt;dd&gt;&lt;/dd&gt;
            &lt;/dl&gt;
            &lt;dl&gt;
              &lt;dt&gt;#displayInput ('authWithCookies')
                 &lt;label for="${propNamePrefix}_authWithCookies"&gt;#t ('authWithCookies')&lt;/label&gt;
              &lt;span class="xHint"&gt;#t ('authWithCookies.hint')&lt;/span&gt;&lt;/dt&gt;
            &lt;/dl&gt;

            &lt;dl&gt;
                &lt;dt&gt;&lt;label for="${propNamePrefix}_cookiesTTL"&gt;#t("cookiesTTL")&lt;/label&gt;
                   &lt;span class="xHint"&gt;#t ('cookiesTTL.hint')&lt;/span&gt;&lt;/dt&gt;
                &lt;dd&gt;#displayInput ('cookiesTTL')&lt;/dd&gt;
            &lt;/dl&gt;
          &lt;/dd&gt;
      &lt;/dl&gt;
    &lt;/fieldset&gt;


    ## Hidden form elements
    #set ($params = "editor=${escapetool.url(${editor})}&amp;amp;section=${escapetool.url(${section})}")
    #set ($params = "${params}&amp;amp;space=${escapetool.url(${currentSpace})}")
    #set ($continueURL = $xwiki.getURL($currentDoc, 'admin', $params))
    &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
    &lt;input type="hidden" name="xcontinue" value="${continueURL}" /&gt;
    &lt;input type="hidden" name="xredirect" value="${continueURL}" /&gt;

    ## submit
    &lt;div class="bottombuttons"&gt;
      &lt;p class="admin-buttons"&gt;
        &lt;span class="buttonwrapper"&gt;&lt;input class="button" type="submit" name="formactionsac"
          value="$services.localization.render('admin.save')" /&gt;&lt;/span&gt;
      &lt;/p&gt;
    &lt;/div&gt;
  &lt;/form&gt;

  &lt;div id="driveOnNowWhat"&gt;

    &lt;p&gt;#tp ('nowWhat1', ['[[',"&gt;&gt;${xwiki.getURL('GoogleApps.TestDocumentList')}]]"])&lt;/p&gt;

    &lt;p&gt;#tp ('nowWhat2', ['&lt;code&gt;{{drive/}}&lt;/code&gt;'])&lt;/p&gt;

  &lt;/div&gt;
  {{/html}}
#end
{{/velocity}}</content>
</xwikidoc>
